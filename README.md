# PanoBEV-3D: DRRからの3D情報復元プロジェクト

本プロジェクトは、単一のDRR（2D疑似X線写真）から、鳥瞰図（BEV）と深度マップを同時に予測することで、3次元的なシーン理解を目指す深層学習プロジェクトです。

## プロジェクトの目標

1枚のDRR画像から、End-to-Endで以下の2つの情報を復元するマルチタスクモデルを構築する。
1.  **BEVセグメンテーション**: 空間内の重要オブジェクト（肺結節）の(X, Z)位置を特定する。
2.  **深度予測**: DRR画像の各ピクセルにおける、視点から物体表面までの距離(Y)を特定する。

これにより、2D画像から3Dの「位置」と「形状」を同時に理解するモデルの実現を目指します。

## パイプラインと主要スクリプト

本プロジェクトは、以下の自動化されたパイプラインで構成されています。

-   `drr_generator.py`: 3D-CTデータから、DRR画像、BEVマップ、深度マップを生成するコアモジュール。
-   `build_dataset.py`: LIDC-IDRIデータセットを読み込み、学習(train)・検証(val)・テスト(test)用に自動で分割・保存するデータセット構築スクリプト。
-   `train.py`: データ増強を含む学習・検証サイクルを回し、最も性能の良いモデルを自動で保存する学習スクリプト。
-   `inference.py`: 学習済みモデルを使い、未知のテストデータに対する予測結果を可視化する推論スクリプト。

### 補助的な可視化・分析ツール

-   `visualize_3d.py`: CTデータを直接サーフェスレンダリングし、3Dモデルとして可視化するツール。
-   `reconstruct_3d_from_bev.py`: モデルが予測したBEVマップを3D空間に逆射影し、モデルの判断根拠を3Dで分析するツール。

## これまでの成果と知見 (v1.0)

-   **v0.1: ベースライン構築**
    -   2D→2.5D（BEV）のベースラインモデルを構築。推論結果から、モデルが画像の「フチ」に反応するなどの課題を発見。
-   **v0.2: 深度予測の導入**
    -   深度マップを教師データに追加し、マルチタスク学習に移行。
    -   **[知見]** 損失のスケールが全く異なり、学習が不安定になる問題が発生。単純な損失の合計は機能しないことを確認。
-   **v0.3: データ正規化と損失の安定**
    -   深度マップを0-1に正規化することで、学習ロスが安定して減少することを確認。
    -   **[知見]** `pos_weight`未設定では、不均衡データによりモデルが結節を全く検出できない（偽陰性）問題を発見。
-   **v0.4: 偽陰性への対策**
    -   `pos_weight`を導入し、小さな結節を検出できるようになった。
    -   **[知見]** `pos_weight`が強すぎると、今度は結節がない場所にも反応する（偽陽性）トレードオフの関係を発見。
-   **v0.5: 偽陽性への対策**
    -   3D再構成による分析から、モデルがCTのアーチファクト（水平線）に過剰反応しているという仮説を立案。
    -   **[知見]** 対策としてデータ増強（Data Augmentation）を導入し、現在モデルを再学習中。

---



